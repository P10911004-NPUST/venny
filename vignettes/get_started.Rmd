---
title: "Get started with `venny`"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Get started with `venny`}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = FALSE,
    comment = "#>"
)
```

## Install

This vignette requires five packages to work with. Make sure they are installed.

- `tidyverse`: data manipulation;
- `org.At.tair.db`: *Arabidopsis thaliana* database;
- `DESeq2`: differentially expressed gene (DEG) analysis;
- `clusterProfiler`: gene ontology analysis;
- `venny`: target genes extraction and venn diagram plotting.

```{r setup, message=FALSE}
# if (!require(tidyverse)) install.packages("tidyverse")
# if (!require(devtools)) install.packages("devtools")
# if (!require(BiocManager)) install.packages("BiocManager")
# if (!require(org.At.tair.db)) BiocManager::install("org.At.tair.db", ask = FALSE)
# if (!require(DESeq2)) BiocManager::install("DESeq2", ask = FALSE)
# if (!require(clusterProfiler)) BiocManager::install("clusterProfiler", ask = FALSE)
# if (!require(venny)) devtools::install_github("P10911004-NPUST/venny")
library(tidyverse)
library(org.At.tair.db)
library(DESeq2)
library(clusterProfiler)
library(venny)
```

## Data

```{r}
cmat <- LGL23$count_matrix
sample_info <- LGL23$sample_info
```

## DEGs

Two sets of up-regulated DEGs (`set_A` and `set_B`) are selected.

- `set_A`: Genes that are up-regulated under low concentration treatment, compare to mock.
- `set_B`: Genes that are up-regulated under high concentration treatment, compare to low concentration

```{r, message=FALSE}
dds <- DESeq2::DESeqDataSetFromMatrix(
    countData = cmat,
    colData = sample_info,
    design = ~ group
)
dds <- DESeq2::DESeq(dds)
# saveRDS(dds, "../data-raw/dds.rds")
# dds <- readRDS("../data-raw/dds.rds")

set_A <- DESeq2::results(dds, contrast = c("group", "WT_low", "WT_mock")) %>%
    as.data.frame() %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    rownames()

set_B <- DESeq2::results(dds, c("group", "WT_high", "WT_low")) %>%
    as.data.frame() %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    rownames()
```

## Venn diagram (2 sets)

The 2 sets venn diagram delivers 3 subsets (refer as "zones" here), i.e. A, AB, and B.

The zones AB consists of genes (869 genes, 21.69%) that are gradually up-regulated along treatment concentration.

```{r venn, out.width="50%", fig.align='center', fig.dpi=660, fig.dim=c(2, 1.5), fig.cap="A two-sets venn diagram."}
out <- venny(data = list(A = set_A, B = set_B), text_size = 4)

zone_AB_polygon <- out$ellipse_path$A %>%
    polygon_intersect(out$ellipse_path$B) %>%
    as.data.frame()

out$plot +
    geom_polygon(
        inherit.aes = FALSE,
        data = zone_AB_polygon,
        mapping = aes(x, y),
        fill = NA,
        color = "red",
        linewidth = 2
    )
```

## GO analysis

```{r go-dotplot, out.width="95%", fig.align='center', fig.dpi=1200, fig.dim=c(5, 3), fig.cap="Gene ontology"}
GO <- clusterProfiler::enrichGO(
    gene = out$zone_elements$AB,
    OrgDb = org.At.tair.db,
    keyType = "TAIR",
    ont = "BP",
    pvalueCutoff = 0.01,
    qvalueCutoff = 0.05
) %>% 
    clusterProfiler::simplify() %>% 
    .@result

GO_top10 <- GO %>% slice_max(RichFactor, n = 10)

GO_top10 %>% 
    ggplot(
        aes(
            x = RichFactor, 
            y = fct_reorder(Description, RichFactor), 
            color = qvalue, 
            size = Count
        )
    ) +
    theme_bw() +
    labs(x = "Rich factor", y = "Description") +
    geom_point() +
    scale_x_continuous(limits = c(0.1, 0.5)) +
    scale_y_discrete(labels = function(x) str_wrap(x, 40)) +
    scale_color_gradientn(
            colours = c("#1d3557", "#457b9d", "#a8dadc"),
            trans = "log10",
            guide = guide_colorbar(
                reverse = FALSE,
                order = 1,
                theme = theme(legend.key.size = grid::unit(1, "cm"))
            )
        ) +
    theme(
        text = element_text(size = 8)
    )
```

## Genes of interest based on GO analysis

Extract the cell division and meristem related genes from the GO term and search for the gene functional descriptions.

```{r}
GOI <- GO_top10 %>% 
    filter(str_detect(Description, "cell division|meristem")) %>% 
    pull(geneID) %>% 
    paste(collapse = "/") %>% 
    str_split_1("/")

GFD <- LGL23$GFD %>% 
    filter(gene_id %in% GOI) %>% 
    select("gene_id", "symbol", "full_name", "Curator_summary")


```




```{r, eval=FALSE, echo=FALSE}
# rmarkdown::render("./vignettes/example_2-sets.Rmd", clean = FALSE, envir = new.env(), quiet = FALSE)
```

